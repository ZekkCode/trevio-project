name: Auto Deploy Robust

on:
  push:
    branches:
      - main
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 2024
          script: |
            # ===================================================
            # 1. LOGIC UNTUK PRODUCTION (Branch: main)
            # ===================================================
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              echo "ðŸš€ STARTING DEPLOYMENT TO PRODUCTION..."
              
              # Definisi Folder
              TARGET_DIR="/var/www/trevio-prod"
              BRANCH="main"
              
              # Buat folder jika belum ada
              sudo mkdir -p $TARGET_DIR
              sudo chown -R $USER:$USER $TARGET_DIR
              
              # Masuk ke folder
              cd $TARGET_DIR
              
              # Tandai folder aman untuk Git
              git config --global --add safe.directory $TARGET_DIR
              
              # Inisialisasi Git jika folder masih kosong
              if [ ! -d ".git" ]; then
                echo "ðŸ“‚ Cloning Repository for the first time..."
                git clone -b $BRANCH git@github.com:${{ github.repository }}.git .
              else
                echo "ðŸ”„ Updating Repository..."
                
                # [KUNCI ANTI MACET 1] Abaikan perubahan permission file
                git config core.filemode false
                
                # [KUNCI ANTI MACET 2] Jangan merge. Ambil data baru, lalu RESET HARD.
                # Ini akan membuang semua perubahan manual/konflik di server.
                git fetch origin $BRANCH
                git reset --hard origin/$BRANCH
              fi
              
              # [STEP TERAKHIR] Fix Permission agar Nginx/PHP bisa baca tulis
              echo "ðŸ”’ Fixing Permissions..."
              sudo chown -R www-data:www-data $TARGET_DIR
              sudo chmod -R 775 $TARGET_DIR
              
              echo "âœ… PRODUCTION DEPLOYMENT SUCCESS!"
            fi

            # ===================================================
            # 2. LOGIC UNTUK DEVELOPMENT (Branch: development)
            # ===================================================
            if [ "${{ github.ref }}" = "refs/heads/development" ]; then
              echo "ðŸš§ STARTING DEPLOYMENT TO DEVELOPMENT..."
              
              TARGET_DIR="/var/www/trevio-dev"
              BRANCH="development"
              
              sudo mkdir -p $TARGET_DIR
              sudo chown -R $USER:$USER $TARGET_DIR
              
              cd $TARGET_DIR
              
              git config --global --add safe.directory $TARGET_DIR
              
              if [ ! -d ".git" ]; then
                echo "ðŸ“‚ Cloning Repository for the first time..."
                git clone -b $BRANCH git@github.com:${{ github.repository }}.git .
              else
                echo "ðŸ”„ Updating Repository..."
                
                # Abaikan chmod changes
                git config core.filemode false
                
                # Hard Reset (Paksa update)
                git fetch origin $BRANCH
                git reset --hard origin/$BRANCH
              fi
              
              echo "ðŸ”’ Fixing Permissions..."
              sudo chown -R www-data:www-data $TARGET_DIR
              sudo chmod -R 775 $TARGET_DIR
              
              echo "âœ… DEVELOPMENT DEPLOYMENT SUCCESS!"
            fi